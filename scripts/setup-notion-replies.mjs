#!/usr/bin/env node

/**
 * å»ºç«‹è©±è¡“è³‡æ–™åº«ä¸¦å¡«å…¥åˆå§‹è³‡æ–™
 *
 * ä½¿ç”¨æ–¹å¼:
 * node scripts/setup-notion-replies.mjs
 */

import { readFileSync } from 'fs'
import { fileURLToPath } from 'url'
import { dirname, resolve } from 'path'

// æ‰‹å‹•è¼‰å…¥ .env.local
const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

function loadEnv() {
  try {
    const envPath = resolve(__dirname, '../.env.local')
    const content = readFileSync(envPath, 'utf-8')
    const lines = content.split('\n')

    for (const line of lines) {
      const trimmed = line.trim()
      if (!trimmed || trimmed.startsWith('#')) continue

      const eqIndex = trimmed.indexOf('=')
      if (eqIndex === -1) continue

      const key = trimmed.slice(0, eqIndex)
      let value = trimmed.slice(eqIndex + 1)

      // ç§»é™¤å¼•è™Ÿ
      if ((value.startsWith('"') && value.endsWith('"')) ||
          (value.startsWith("'") && value.endsWith("'"))) {
        value = value.slice(1, -1)
      }

      process.env[key] = value
    }
  } catch (e) {
    // .env.local ä¸å­˜åœ¨å‰‡è·³é
  }
}

loadEnv()

const NOTION_TOKEN = process.env.NOTION_KNOWLEDGE_TOKEN
const NOTION_VERSION = '2022-06-28'
const REPLIES_DB = process.env.NOTION_REPLIES_DB

if (!NOTION_TOKEN) {
  console.error('âŒ è«‹è¨­å®š NOTION_KNOWLEDGE_TOKEN ç’°å¢ƒè®Šæ•¸')
  process.exit(1)
}

if (!REPLIES_DB) {
  console.error('âŒ è«‹è¨­å®š NOTION_REPLIES_DB ç’°å¢ƒè®Šæ•¸')
  process.exit(1)
}

async function notionRequest(endpoint, method = 'GET', body = null) {
  const options = {
    method,
    headers: {
      'Authorization': `Bearer ${NOTION_TOKEN}`,
      'Notion-Version': NOTION_VERSION,
      'Content-Type': 'application/json',
    },
  }

  if (body) {
    options.body = JSON.stringify(body)
  }

  const response = await fetch(`https://api.notion.com/v1${endpoint}`, options)
  const data = await response.json()

  if (!response.ok) {
    console.error('API éŒ¯èª¤:', data)
    throw new Error(data.message || 'Notion API éŒ¯èª¤')
  }

  return data
}

// ====================================
// è©±è¡“è³‡æ–™
// ====================================

const replies = [
  // === å®Œæ•´ç¯„æœ¬ ===
  {
    category: 'å®Œæ•´ç¯„æœ¬',
    title: 'å ±åƒ¹ç¢ºèªç¯„æœ¬',
    content: `<é€™æ˜¯æˆ‘å€‘å“ç‰Œå®˜ç¶²ï¼Œå†éº»ç…©è«‹è©³é–±ä¸€äº›å¸¸è¦‹QA>
1.åŒ…è»Šå¸¸è¦‹å•é¡Œ (å«ç”¨è»ŠåŒ…å«è²»ç”¨ï¼Œæ™‚é–“ï¼Œæ–¹å¼ç­‰ç­‰é ˆçŸ¥)
https://chiangway-travel.com/services/car-charter
2.é€€æ¬¾æ”¿ç­–
https://chiangway-travel.com/cancellation

---

**åŒ…å«:** æ²¹è²»ã€åœè»Šè²»ã€éè·¯è²»ã€å¤–åœ°ä½å®¿è£œè²¼ã€æ³°åœ‹æ—…éŠä¿éšª
**ç”¨è»Šæ™‚é–“:** æ¸…é‚10å°æ™‚; æ¸…èŠ12å°æ™‚ï¼Œè¶…æ™‚å†éº»ç…©è£œçµ¦å¸æ©Ÿ200/hr
**å°è²»:** çœ‹æœå‹™è·Ÿå¿ƒæ„ï¼Œä¸å¼·åˆ¶~ (æœ‰çµ¦çš„è©±å¸æ©Ÿè·Ÿå°éŠæœƒå¾ˆé–‹å¿ƒ)

**ä¸åŒ…å«:** é–€ç¥¨ã€é¤è²»ã€æ©Ÿç¥¨è·Ÿé£¯åº—ã€å°è²»ã€å€‹äººèŠ±è²»

---

å°éŠæœƒå…¨ç¨‹ç…§é¡§å¤§å®¶ï¼ŒåŒ…å«æ™¯é»æ–‡åŒ–å°è¦½ã€é¤å»³æ¨è–¦é»èœ
æˆ‘å€‘ä¹Ÿæœƒå…¨ç¨‹åœ¨ç¾¤çµ„ç·šä¸Šä¸­æ–‡å”åŠ©ï¼Œå¹«å¿™é è¨‚é¤å»³ï¼Œå”åŠ©ä¸€äº›æ„å¤–ç‹€æ³
é–€ç¥¨è²»ç”¨è·Ÿé¤è²»å¯ä»¥æ ¹æ“šé ç®—è®“å°éŠè™•ç†
ä¾‹å¦‚: ç¬¬ä¸€å¤©æ›éŒ¢å¾Œå…ˆçµ¦å°éŠ20000æ³°éŠ–ï¼Œäº¤ä»£ç”¨é¤å£å‘³åå¥½
(å¦‚:ä¸åƒæµ·é®®ï¼Œç‰›è‚‰ï¼Œèœè‰²ä¸è¦å¤ªè¾£ç­‰ç­‰)
æ¯ä¸€ç­†éƒ½æœƒè«‹å¥¹è¨˜éŒ„ï¼Œå¤šé€€å°‘è£œï¼Œé€™æ¨£å¾ŒçºŒå¤§å®¶ç®—éŒ¢æœƒæ¯”è¼ƒç°¡å–®è·Ÿæ¸…æ¥š

---

ç¢ºèªçš„è©±è¦éº»ç…©æ‚¨å…ˆè½‰è¨‚é‡‘ {{è¨‚é‡‘é‡‘é¡}}
(å°¾æ¬¾ {{ç¸½åƒ¹}}-{{è¨‚é‡‘é‡‘é¡}}={{å°¾æ¬¾é‡‘é¡}}ï¼Œæ–¼åŒ…è»ŠçµæŸç•¶å¤©åŒ¯æ¬¾)

æˆ¶å: è”¡æŸè£•
éŠ€è¡Œåç¨±ï¼šå½°åŒ–éŠ€è¡Œ
éŠ€è¡Œä»£ç¢¼ï¼š009
å¸³è™Ÿï¼š51619501772100

**æ„Ÿè¬æ‚¨é¸æ“‡æˆ‘å€‘æ¸…å¾®æ—…è¡Œçš„åŒ…è»Šï¼Œå¸Œæœ›èƒ½å¸¶çµ¦æ‚¨èˆ‡å®¶äººæœ‹å‹å€‘ä¸€è¶Ÿé›£å¿˜çš„æ¸…é‚åŒ…è»Šé«”é©—!**`,
    note: 'å®¢æˆ¶ç¢ºèªè¦è¨‚æ™‚ç™¼é€ï¼Œéœ€æ›¿æ› {{è¨‚é‡‘é‡‘é¡}}ã€{{ç¸½åƒ¹}}ã€{{å°¾æ¬¾é‡‘é¡}}',
    order: 1,
  },
  {
    category: 'å®Œæ•´ç¯„æœ¬',
    title: 'æ”¶åˆ°è¨‚é‡‘å¾Œç¯„æœ¬',
    content: `æ”¶åˆ°æ¬¾é …ç¢ºèªæ²’å•é¡Œï¼

å†éº»ç…©åŠ ä¸€ä¸‹æˆ‘çš„å€‹äººline:
1003904

å®‰æ’å¥½è»Šä¹‹å¾Œï¼Œæˆ‘æœƒé–‹ä¸€å€‹ç¾¤çµ„é‚€è«‹æ‚¨èˆ‡åœ˜éšŠçš„å°éŠ(å¸æ©Ÿ)ï¼Œé‚„æœ‰æˆ‘çš„å¤ªå¤ªï¼Œéƒ½æ˜¯æ³°åœ‹äººï¼Œéƒ½æœƒç”¨ä¸­æ–‡å”åŠ©è¯çµ¡ã€‚

è¡Œç¨‹æœƒè²¼åœ¨ç¾¤çµ„è¨˜äº‹æœ¬ï¼Œå…¨ç¨‹æœ‰ä»»ä½•çªç™¼ç‹€æ³æˆ‘å€‘éƒ½æœƒéš¨æ™‚é€£çµ¡ä¿æŒè¯ç¹«èˆ‡è™•ç†ã€‚`,
    note: 'ç¢ºèªæ”¶åˆ°è¨‚é‡‘å¾Œç™¼é€',
    order: 2,
  },
  {
    category: 'å®Œæ•´ç¯„æœ¬',
    title: 'è¡Œå‰æé†’ç¯„æœ¬',
    content: `**æº«é¦¨æé†’**

1. æ³°åœ‹å…¥å¢ƒçš„è¦å®šæ˜¯æ¯äººè‡³å°‘æ”œå¸¶20000å¡Š(æ¯çµ„å®¶åº­40000å¡Š)çš„ç­‰å€¼æ³°éŠ–(ä¹Ÿå¯ä»¥æ˜¯å°å¹£æˆ–ç¾é‡‘)ï¼Œé›–ç„¶ä¸ä¸€å®šæœƒè¢«æŠ½æŸ¥ï¼Œå»ºè­°é‚„æ˜¯éµå®ˆç›¸é—œè¦å®š!

2. æ¸…é‚æœ€å¥½çš„å·«å®—é›„åŒ¯ç‡: {{åŒ¯ç‡è³‡è¨Š}}

3. å…¥å¢ƒè¦å¡«TDAC (å‡ºåœ‹3å¤©å‰å…ˆå¡«å¥½)
https://tdac.immigration.go.th/arrival-card/#/home

4. æ¸…é‚12~2æœˆæ—©æ™šæº«å·®å¤§ï¼Œå»ºè­°æ”œå¸¶ä¸€ä»¶è–„å¤–å¥—`,
    note: 'å‡ºç™¼å‰ 3 å¤©ç™¼é€ï¼Œéœ€æ›¿æ› {{åŒ¯ç‡è³‡è¨Š}}',
    order: 3,
  },

  // === æœå‹™èªªæ˜ ===
  {
    category: 'æœå‹™èªªæ˜',
    title: 'åŒ…å«è²»ç”¨',
    content: `**åŒ…å«:** æ²¹è²»ã€åœè»Šè²»ã€éè·¯è²»ã€å¤–åœ°ä½å®¿è£œè²¼ã€æ³°åœ‹æ—…éŠä¿éšª`,
    note: 'èªªæ˜åŒ…è»Šè²»ç”¨åŒ…å«é …ç›®',
    order: 10,
  },
  {
    category: 'æœå‹™èªªæ˜',
    title: 'ä¸åŒ…å«è²»ç”¨',
    content: `**ä¸åŒ…å«:** é–€ç¥¨ã€é¤è²»ã€æ©Ÿç¥¨è·Ÿé£¯åº—ã€å°è²»ã€å€‹äººèŠ±è²»`,
    note: 'èªªæ˜åŒ…è»Šè²»ç”¨ä¸åŒ…å«é …ç›®',
    order: 11,
  },
  {
    category: 'æœå‹™èªªæ˜',
    title: 'ç”¨è»Šæ™‚é–“èªªæ˜',
    content: `**ç”¨è»Šæ™‚é–“:** æ¸…é‚10å°æ™‚; æ¸…èŠ12å°æ™‚ï¼Œè¶…æ™‚å†éº»ç…©è£œçµ¦å¸æ©Ÿ200/hr`,
    note: 'èªªæ˜ç”¨è»Šæ™‚é–“èˆ‡è¶…æ™‚è²»ç”¨',
    order: 12,
  },
  {
    category: 'æœå‹™èªªæ˜',
    title: 'å°éŠæœå‹™èªªæ˜',
    content: `å°éŠæœƒå…¨ç¨‹ç…§é¡§å¤§å®¶ï¼ŒåŒ…å«æ™¯é»æ–‡åŒ–å°è¦½ã€é¤å»³æ¨è–¦é»èœ
æˆ‘å€‘ä¹Ÿæœƒå…¨ç¨‹åœ¨ç¾¤çµ„ç·šä¸Šä¸­æ–‡å”åŠ©ï¼Œå¹«å¿™é è¨‚é¤å»³ï¼Œå”åŠ©ä¸€äº›æ„å¤–ç‹€æ³
é–€ç¥¨è²»ç”¨è·Ÿé¤è²»å¯ä»¥æ ¹æ“šé ç®—è®“å°éŠè™•ç†
ä¾‹å¦‚: ç¬¬ä¸€å¤©æ›éŒ¢å¾Œå…ˆçµ¦å°éŠ20000æ³°éŠ–ï¼Œäº¤ä»£ç”¨é¤å£å‘³åå¥½
(å¦‚:ä¸åƒæµ·é®®ï¼Œç‰›è‚‰ï¼Œèœè‰²ä¸è¦å¤ªè¾£ç­‰ç­‰)
æ¯ä¸€ç­†éƒ½æœƒè«‹å¥¹è¨˜éŒ„ï¼Œå¤šé€€å°‘è£œï¼Œé€™æ¨£å¾ŒçºŒå¤§å®¶ç®—éŒ¢æœƒæ¯”è¼ƒç°¡å–®è·Ÿæ¸…æ¥š`,
    note: 'èªªæ˜å°éŠè·è²¬èˆ‡è²»ç”¨è™•ç†æ–¹å¼',
    order: 13,
  },
  {
    category: 'æœå‹™èªªæ˜',
    title: 'å°è²»èªªæ˜',
    content: `**å°è²»:** çœ‹æœå‹™è·Ÿå¿ƒæ„ï¼Œä¸å¼·åˆ¶~ (æœ‰çµ¦çš„è©±å¸æ©Ÿè·Ÿå°éŠæœƒå¾ˆé–‹å¿ƒ)`,
    note: 'èªªæ˜å°è²»ç›¸é—œ',
    order: 14,
  },

  // === è¡Œå‰æé†’ ===
  {
    category: 'è¡Œå‰æé†’',
    title: 'å…¥å¢ƒé ˆçŸ¥',
    content: `æ³°åœ‹å…¥å¢ƒçš„è¦å®šæ˜¯æ¯äººè‡³å°‘æ”œå¸¶20000å¡Š(æ¯çµ„å®¶åº­40000å¡Š)çš„ç­‰å€¼æ³°éŠ–(ä¹Ÿå¯ä»¥æ˜¯å°å¹£æˆ–ç¾é‡‘)ï¼Œé›–ç„¶ä¸ä¸€å®šæœƒè¢«æŠ½æŸ¥ï¼Œå»ºè­°é‚„æ˜¯éµå®ˆç›¸é—œè¦å®š!`,
    note: 'èªªæ˜æ³°åœ‹å…¥å¢ƒç¾é‡‘è¦å®š',
    order: 20,
  },
  {
    category: 'è¡Œå‰æé†’',
    title: 'åŒ¯ç‡è³‡è¨Š',
    content: `æ¸…é‚æœ€å¥½çš„å·«å®—é›„åŒ¯ç‡: æˆªè‡³ {{æ—¥æœŸ}} æœ€æ–° (æ³°éŠ–:å°å¹£=1:{{åŒ¯ç‡}})`,
    note: 'éœ€å®šæœŸæ›´æ–°åŒ¯ç‡ï¼Œæ›¿æ› {{æ—¥æœŸ}} å’Œ {{åŒ¯ç‡}}',
    order: 21,
  },
  {
    category: 'è¡Œå‰æé†’',
    title: 'TDAC å¡«å¯«æé†’',
    content: `å…¥å¢ƒè¦å¡«TDAC (å‡ºåœ‹3å¤©å‰å…ˆå¡«å¥½)
https://tdac.immigration.go.th/arrival-card/#/home`,
    note: 'æé†’å®¢æˆ¶å¡«å¯«æ³°åœ‹å…¥å¢ƒå¡',
    order: 22,
  },
  {
    category: 'è¡Œå‰æé†’',
    title: 'å¤©æ°£æé†’',
    content: `æ¸…é‚12~2æœˆæ—©æ™šæº«å·®å¤§ï¼Œå»ºè­°æ”œå¸¶ä¸€ä»¶è–„å¤–å¥—`,
    note: '12-2æœˆæ¶¼å­£æé†’',
    order: 23,
  },

  // === ä»˜æ¬¾ç›¸é—œ ===
  {
    category: 'ä»˜æ¬¾ç›¸é—œ',
    title: 'è¨‚é‡‘ä»˜æ¬¾è³‡è¨Š',
    content: `ç¢ºèªçš„è©±è¦éº»ç…©æ‚¨å…ˆè½‰è¨‚é‡‘ {{è¨‚é‡‘é‡‘é¡}}
(å°¾æ¬¾ {{ç¸½åƒ¹}}-{{è¨‚é‡‘é‡‘é¡}}={{å°¾æ¬¾é‡‘é¡}}ï¼Œæ–¼åŒ…è»ŠçµæŸç•¶å¤©åŒ¯æ¬¾)

æˆ¶å: è”¡æŸè£•
éŠ€è¡Œåç¨±ï¼šå½°åŒ–éŠ€è¡Œ
éŠ€è¡Œä»£ç¢¼ï¼š009
å¸³è™Ÿï¼š51619501772100`,
    note: 'è¨‚é‡‘ä»˜æ¬¾èªªæ˜ï¼Œéœ€æ›¿æ›é‡‘é¡ä½”ä½ç¬¦',
    order: 30,
  },
  {
    category: 'ä»˜æ¬¾ç›¸é—œ',
    title: 'å¾ŒçºŒæµç¨‹èªªæ˜',
    content: `æ”¶åˆ°æ¬¾é …å¾…ç¢ºèªæ²’å•é¡Œå¾Œï¼Œå†éº»ç…©åŠ ä¸€ä¸‹æˆ‘çš„å€‹äººline:
1003904

å®‰æ’å¥½è»Šä¹‹å¾Œï¼Œæˆ‘æœƒé–‹ä¸€å€‹ç¾¤çµ„é‚€è«‹æ‚¨èˆ‡åœ˜éšŠçš„å°éŠ(å¸æ©Ÿ)ï¼Œé‚„æœ‰æˆ‘çš„å¤ªå¤ªï¼Œéƒ½æ˜¯æ³°åœ‹äººï¼Œéƒ½æœƒç”¨ä¸­æ–‡å”åŠ©è¯çµ¡ã€‚

è¡Œç¨‹æœƒè²¼åœ¨ç¾¤çµ„è¨˜äº‹æœ¬ï¼Œå…¨ç¨‹æœ‰ä»»ä½•çªç™¼ç‹€æ³æˆ‘å€‘éƒ½æœƒéš¨æ™‚é€£çµ¡ä¿æŒè¯ç¹«èˆ‡è™•ç†ã€‚`,
    note: 'èªªæ˜æ”¶åˆ°è¨‚é‡‘å¾Œçš„æµç¨‹',
    order: 31,
  },

  // === é€£çµ ===
  {
    category: 'é€£çµ',
    title: 'å®˜ç¶²é€£çµ',
    content: `<é€™æ˜¯æˆ‘å€‘å“ç‰Œå®˜ç¶²ï¼Œå†éº»ç…©è«‹è©³é–±ä¸€äº›å¸¸è¦‹QA>
1.åŒ…è»Šå¸¸è¦‹å•é¡Œ (å«ç”¨è»ŠåŒ…å«è²»ç”¨ï¼Œæ™‚é–“ï¼Œæ–¹å¼ç­‰ç­‰é ˆçŸ¥)
https://chiangway-travel.com/services/car-charter
2.é€€æ¬¾æ”¿ç­–
https://chiangway-travel.com/cancellation`,
    note: 'å¼•å°å®¢æˆ¶é–±è®€å®˜ç¶² FAQ',
    order: 40,
  },

  // === å…¶ä»– ===
  {
    category: 'å…¶ä»–',
    title: 'æ„Ÿè¬èª',
    content: `**æ„Ÿè¬æ‚¨é¸æ“‡æˆ‘å€‘æ¸…å¾®æ—…è¡Œçš„åŒ…è»Šï¼Œå¸Œæœ›èƒ½å¸¶çµ¦æ‚¨èˆ‡å®¶äººæœ‹å‹å€‘ä¸€è¶Ÿé›£å¿˜çš„æ¸…é‚åŒ…è»Šé«”é©—!**`,
    note: 'çµå°¾æ„Ÿè¬èª',
    order: 50,
  },
]

// ====================================
// æª¢æŸ¥è³‡æ–™åº«çµæ§‹
// ====================================
async function checkDatabaseSchema() {
  console.log('ğŸ” æª¢æŸ¥è©±è¡“è³‡æ–™åº«çµæ§‹...')

  const db = await notionRequest(`/databases/${REPLIES_DB}`)

  console.log(`ğŸ“‹ è³‡æ–™åº«åç¨±: ${db.title?.[0]?.plain_text || '(ç„¡æ¨™é¡Œ)'}`)
  console.log('ğŸ“Š ç¾æœ‰æ¬„ä½:')

  for (const [name, prop] of Object.entries(db.properties)) {
    console.log(`  - ${name}: ${prop.type}`)
  }

  return db.properties
}

// ====================================
// æ›´æ–°è³‡æ–™åº«çµæ§‹
// ====================================
async function updateDatabaseSchema() {
  console.log('\nğŸ”§ æ›´æ–°è³‡æ–™åº«çµæ§‹...')

  await notionRequest(`/databases/${REPLIES_DB}`, 'PATCH', {
    properties: {
      'æ¨™é¡Œ': { title: {} },
      'åˆ†é¡': {
        select: {
          options: [
            { name: 'å®Œæ•´ç¯„æœ¬', color: 'blue' },
            { name: 'æœå‹™èªªæ˜', color: 'green' },
            { name: 'è¡Œå‰æé†’', color: 'orange' },
            { name: 'ä»˜æ¬¾ç›¸é—œ', color: 'red' },
            { name: 'é€£çµ', color: 'purple' },
            { name: 'å…¶ä»–', color: 'gray' },
          ],
        },
      },
      'å…§å®¹': { rich_text: {} },
      'å‚™è¨»': { rich_text: {} },
      'æ’åº': { number: {} },
    },
  })

  console.log('âœ… è³‡æ–™åº«çµæ§‹æ›´æ–°å®Œæˆ')
}

// ====================================
// æ–°å¢è©±è¡“è³‡æ–™
// ====================================
async function addReplies() {
  console.log('\nğŸ’¬ æ–°å¢è©±è¡“è³‡æ–™...\n')

  for (const r of replies) {
    try {
      await notionRequest('/pages', 'POST', {
        parent: { database_id: REPLIES_DB },
        properties: {
          'æ¨™é¡Œ': { title: [{ text: { content: r.title } }] },
          'åˆ†é¡': { select: { name: r.category } },
          'å…§å®¹': { rich_text: [{ text: { content: r.content } }] },
          'å‚™è¨»': { rich_text: [{ text: { content: r.note } }] },
          'æ’åº': { number: r.order },
        },
      })
      console.log(`  âœ… [${r.category}] ${r.title}`)
    } catch (error) {
      console.error(`  âŒ [${r.category}] ${r.title}: ${error.message}`)
    }
  }
}

// ====================================
// ä¸»ç¨‹å¼
// ====================================
async function main() {
  console.log('ğŸš€ é–‹å§‹è¨­å®šè©±è¡“è³‡æ–™åº«\n')
  console.log('='.repeat(50))

  try {
    // 1. æª¢æŸ¥ç¾æœ‰çµæ§‹
    await checkDatabaseSchema()

    // 2. æ›´æ–°çµæ§‹
    await updateDatabaseSchema()

    // 3. æ–°å¢è³‡æ–™
    await addReplies()

    console.log('\n' + '='.repeat(50))
    console.log('ğŸ‰ è©±è¡“è³‡æ–™åº«è¨­å®šå®Œæˆï¼')
    console.log(`\nå…±æ–°å¢ ${replies.length} ç­†è©±è¡“`)
    console.log('\nåˆ†é¡çµ±è¨ˆ:')

    const stats = {}
    for (const r of replies) {
      stats[r.category] = (stats[r.category] || 0) + 1
    }
    for (const [cat, count] of Object.entries(stats)) {
      console.log(`  - ${cat}: ${count} ç­†`)
    }

  } catch (error) {
    console.error('\nâŒ ç™¼ç”ŸéŒ¯èª¤:', error.message)
    process.exit(1)
  }
}

main()
