# Phase 6：個人記帳系統 + 知識庫傳承系統

> 日期：2026-01-26
> 狀態：📝 規劃中

---

## 概述

Phase 6 聚焦於兩個核心功能：
1. **個人記帳系統**：追蹤泰國生活支出、業務成本，確保婚簽 40 萬門檻
2. **知識庫傳承系統**：整合散落資料，為未來女兒接手做準備

| Phase | 性質 | 目的 | 狀態 |
|-------|------|------|------|
| Phase 1 | 公開網站 | 轉換率優化 | ✅ 完成 |
| Phase 2 | SEO 優化 | 流量獲取 | ✅ 完成 |
| Phase 3 | 內部工具 | 營運效率 | ✅ 完成 |
| Phase 4 | 包車展示 | 產品頁面 | ✅ 完成 |
| Phase 5 | 網站優化 | 體驗提升 | ✅ 完成 |
| **Phase 6** | **個人系統** | **財務追蹤 + 傳承** | 📝 規劃中 |

---

## 6.1 個人記帳系統

### 需求摘要

**使用情境：**
- 每 1-2 週開一次 KBank 網銀
- 手動輸入兩個日期的帳戶餘額
- 計算期間支出（含業務成本分離）
- 婚簽要求帳戶至少 40 萬泰銖

**核心功能：**
| 功能 | 說明 |
|------|------|
| 日期區間選擇 | 起始日 < 結束日，2025/01/01 起 |
| 餘額輸入 | 兩筆餘額，起始 ≥ 結束（正常支出情況）|
| 入金記錄 | 期間有轉帳入金時補充記錄 |
| 自動計算 | 總支出 = 起始餘額 + 入金總額 - 結束餘額 |
| Notion 成本串接 | 撈取期間的業務成本 |
| 生活開銷 | 總支出 - 業務成本 = 純生活開銷 |
| 40 萬警示 | 餘額接近門檻時提醒 |

### 邊界條件

| 規則 | 驗證 |
|------|------|
| 日期 A < 日期 B | 起始日不能晚於結束日 |
| 日期 ≤ 今天 | 不能選未來日期 |
| 日期 ≥ 2025/01/01 | 最早追蹤日期 |
| 餘額 ≥ 0 | 不能輸入負數 |
| 入金日期在區間內 | 入金日期必須在 A ~ B 之間 |

### 入金記錄設計

```
簡化版欄位：
├── 日期
├── 台幣金額（從台灣匯出）
├── 泰銖到帳（最終進 KBank）
├── 實際匯率（自動計算：泰銖 ÷ 台幣）
└── 備註（可選）

不追蹤的細節（簡化）：
├── USDT 買入價
├── USDT 賣出價
├── 中間手續費明細
└── 各平台費用
```

### UI 設計

```
路徑：/admin/accounting

┌─────────────────────────────────────────────────────────────┐
│  💰 個人記帳                                    [🔒 已登入]  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  📅 期間設定                                                 │
│  ┌─────────────┐    ┌─────────────┐                         │
│  │ 起始日期    │    │ 結束日期    │                         │
│  │ 2025/12/18  │ →  │ 2026/01/25  │                         │
│  └─────────────┘    └─────────────┘                         │
│                                                              │
│  💳 帳戶餘額                                                 │
│  ┌─────────────┐    ┌─────────────┐                         │
│  │ 起始餘額    │    │ 結束餘額    │                         │
│  │ 745,668 ฿   │    │ 500,000 ฿   │                         │
│  └─────────────┘    └─────────────┘                         │
│                                                              │
│  💵 期間入金（選填）                                         │
│  ┌──────────┬────────────┬────────────┬──────────┬────┐     │
│  │ 日期     │ 台幣       │ 泰銖到帳   │ 匯率     │    │     │
│  ├──────────┼────────────┼────────────┼──────────┼────┤     │
│  │ 01/10    │ 350,000    │ 346,511    │ 0.99     │ ✕  │     │
│  └──────────┴────────────┴────────────┴──────────┴────┘     │
│  [+ 新增入金]                                                │
│                                                              │
│  [計算]                                                      │
│                                                              │
│  ════════════════════════════════════════                   │
│                                                              │
│  📊 計算結果                                                 │
│  ┌─────────────────────────────────────────┐                │
│  │ 期間總支出        │  245,668 ฿          │                │
│  │ 業務成本(Notion)  │   45,000 ฿          │                │
│  │ 生活開銷          │  200,668 ฿          │                │
│  │ 日均支出          │    6,307 ฿/天       │                │
│  │ 40萬門檻狀態      │  ✅ 安全 (餘 10萬)  │                │
│  └─────────────────────────────────────────┘                │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 技術架構

```
src/
├── app/
│   ├── admin/
│   │   └── accounting/
│   │       └── page.tsx           # 記帳頁面（需登入）
│   └── api/
│       └── accounting/
│           └── route.ts           # API：Notion 成本查詢
├── components/
│   └── accounting/
│       ├── DateRangeSelector.tsx  # 日期選擇器
│       ├── BalanceInput.tsx       # 餘額輸入
│       ├── TransferRecords.tsx    # 入金記錄表
│       ├── CalculationResult.tsx  # 計算結果
│       └── ThresholdWarning.tsx   # 40萬警示
└── lib/
    └── accounting/
        ├── calculator.ts          # 計算邏輯
        └── types.ts               # 型別定義
```

### API 設計

```typescript
// POST /api/accounting
// Request
{
  startDate: "2025-12-18",
  endDate: "2026-01-25"
}

// Response
{
  businessCost: 45000,           // 從 Notion 撈取的業務成本
  orders: [                      // 期間訂單明細
    { name: "客戶A", cost: 15000, date: "2025-12-20" },
    { name: "客戶B", cost: 30000, date: "2026-01-05" }
  ],
  parseWarnings: [               // 解析警告
    { orderId: "xxx", message: "成本欄位有不確定值" }
  ]
}
```

---

## 6.2 成本文字解析器

### 問題背景

Notion 的「總成本」欄位是自由格式文字，包含：
- 算式（`2700*2 +4800`）
- 備註（`(已付給小雲)`）
- 調整（`以上調整... 共：24450`）
- 多段加總（`=24450+23680`）
- 不確定描述（`不知道`、`special case`）

### 解析邏輯

```
解析優先順序：

1. 找明確總計（最高優先）
   ├── 關鍵字：「共:」「total:」「成本總共:」
   ├── 最後一行的獨立數字
   └── 最後一個「= 數字」
   → confident: true ✅

2. 處理「以上調整」
   ├── 如果有「以上調整」「調整後」
   └── 用調整後的值，忽略調整前
   → confident: true ✅

3. 多段相加
   ├── 格式：「=A+B」「=A+B+C」
   └── 計算總和
   → confident: true ✅

4. 簡單算式計算
   ├── 沒有明確總計
   └── 嘗試解析並計算
   → confident: false ⚠️

5. 無法解析
   └── 回傳 0，標記需人工確認
   → confident: false ⚠️

特殊標記：
├── 「不知道」「可能」「special case」→ ⚠️ 有值但標記
├── 「客人自付」→ 不計入成本
└── 「到時付」→ 標記為待確認
```

### 測試案例

| 輸入 | 預期輸出 | confident |
|------|---------|-----------|
| `共: 20500\n夜間：650*17= 11050\n=20500+11050` | 31550 | ✅ |
| `共：25250\n以上調整導遊改1500\n共：24450` | 24450 | ✅ |
| `=24450+23680` | 48130 | ✅ |
| `算19000\n不知道郭姐成本...special case` | 19000 | ⚠️ |
| `沒寫數字` | 0 | ⚠️ |

### 實作方式

```
方案：規則式解析 + LLM 備援

流程：
1. 正則表達式嘗試解析
2. 如果規則式有信心值 → 回傳
3. 如果規則式不確定 → 呼叫 Claude API 解析
4. 如果 LLM 也不確定 → 標記需人工確認

Claude API 使用：
├── 模型：claude-3-haiku（便宜快速）
├── Prompt：「解析以下文字中的最終成本金額...」
└── 只在規則式失敗時呼叫，節省 API 費用
```

### 技術架構

```
src/lib/notion/
├── profit-parser.ts           # 現有解析器（基礎版）
└── cost-parser/
    ├── index.ts               # 主入口
    ├── rules.ts               # 規則式解析
    ├── llm-fallback.ts        # LLM 備援
    └── types.ts               # 型別定義

// 型別定義
interface ParseResult {
  value: number;
  confident: boolean;
  warnings: string[];
  rawText: string;
}
```

---

## 6.3 知識庫系統

### 架構設計

```
方案：Notion 為主，網站為入口

Notion（主要編輯區）           網站後台（入口 & 呈現）
════════════════════           ══════════════════════

📂 餐廳資料庫         ──API──→  🔍 /admin/knowledge/restaurants
📂 門票資料庫         ──API──→  🎫 /admin/knowledge/tickets
📂 話術資料庫         ──API──→  💬 /admin/knowledge/replies

📄 系統手冊           ─連結─→   📖 /admin/legacy/manual
📄 給女兒的話         ─連結─→   💝 /admin/legacy/letter
```

### Notion 資料庫結構

#### 餐廳資料庫

| 欄位 | 類型 | 說明 |
|------|------|------|
| 名稱 | Title | 餐廳名稱（泰文） |
| 分類 | Select | 泰式熱炒、泰式燒烤、小陶鍋、脆皮豬、海鮮、咖啡廳 |
| 地圖連結 | URL | Google Maps 連結 |
| 備註 | Text | 特色說明 |
| 推薦度 | Select | ⭐⭐⭐⭐⭐ ~ ⭐⭐⭐ |
| 價位 | Select | 便宜、中等、偏貴 |
| 最後更新 | Date | 資料更新日期 |

**初始資料：**
```
1. ถูก อิ่ม อร่อย ข้าวต้ม 1 บาท | 泰式熱炒 | 1฿粥
2. หมูกระทะช้างเผือก | 泰式燒烤
3. หมูจุ่มเจ้โส | 小陶鍋
4. Neng's Clay Oven Roasted Pork | 脆皮豬
5. 海鮮燒烤369吃到飽
```

#### 門票資料庫

| 欄位 | 類型 | 說明 |
|------|------|------|
| 景點 | Title | 景點名稱 |
| 成人票價 | Number | 泰銖 |
| 兒童票價 | Number | 泰銖 |
| 兒童定義 | Text | 例：101-140cm、3-9歲 |
| 免費條件 | Text | 例：100cm以下、0-3歲 |
| 我方成本 | Number | 如果有代訂成本 |
| 售價含餐 | Number | 對客人報價（含餐） |
| 利潤 | Formula | 售價 - 成本 |
| 備註 | Text | 特殊說明 |
| 最後更新 | Date | 價格更新日期 |

**初始資料：**
```
1. 夜間動物園 | 成人1200 | 兒童600(101-140cm) | 免費<100cm
2. 大象保護營 | 成人1600 | 兒童800(3-9歲) | 免費0-3歲 | 成本600 | 售價1600
3. ATV越野車 10km | 駕駛2000 | 後座800
4. ATV越野車 20km | 駕駛3000 | 後座1300
5. 白河漂流 7km | 1200/人
6. 白河漂流 10km | 1800/人
7. 大象便便造紙公園 | 150 | 免費0-3歲
8. 清邁大峽谷水上樂園 | 成人950 | 兒童750(90-120cm) | 免費<90cm
9. 3D博物館 | 成人400 | 兒童240(100-140cm) | 免費<100cm
10. 茵他儂國家公園 | 成人300 | 兒童150(3-14歲) | 免費0-3歲
11. 豬豬農場 | 200/人
12. Phoenix Adventure Park | 小火車90 | 2歲以下免費
13. 長頸村 | 300/人
14. 清道竹伐 | 500/艘(2-3人)
```

#### 話術資料庫

| 欄位 | 類型 | 說明 |
|------|------|------|
| 情境 | Select | 詢價、天氣、行程確認、售後... |
| 標題 | Title | 簡短描述 |
| 回覆內容 | Text | 完整話術 |
| 備註 | Text | 使用時機說明 |

### 行程表連動

```
Phase 3 行程表                    門票資料庫
══════════════                    ══════════

景點：[夜間動物園 ▼]  ────關聯────→  夜間動物園
                                     ├── 成人：1200
客戶人數：                           ├── 兒童：600
成人 2 人                            └── 免費：<100cm
兒童 1 人 (120cm)
幼兒 1 人 (80cm)

自動計算：
├── 門票預估：1200×2 + 600×1 + 0 = 3000 ฿
├── 我方成本：（如果有代訂）
└── 建議售價：（如果有設定）
```

---

## 6.4 權限設計

### 層級定義

| Level | 角色 | 記帳系統 | 知識庫 | Dashboard | 機密資訊 |
|-------|------|---------|--------|-----------|---------|
| Owner | Eric | ✅ 完整 | ✅ 編輯 | ✅ 完整 | ✅ |
| Family | 女兒 | ❌ | ✅ 查看 | ✅ 唯讀 | ⚠️ 分階段 |
| Collaborator | 合作者 | ❌ | ✅ 唯讀 | ⚠️ 統計 | ❌ |

### 實作方式

```typescript
// src/lib/auth/roles.ts

export const ROLES = {
  OWNER: 'owner',
  FAMILY: 'family',
  COLLABORATOR: 'collaborator',
} as const;

export const PERMISSIONS = {
  [ROLES.OWNER]: {
    accounting: true,
    knowledge: 'edit',
    dashboard: 'full',
    legacy: 'full',
  },
  [ROLES.FAMILY]: {
    accounting: false,
    knowledge: 'view',
    dashboard: 'readonly',
    legacy: 'partial',  // 不含機密
  },
  [ROLES.COLLABORATOR]: {
    accounting: false,
    knowledge: 'view',
    dashboard: 'stats',  // 只看統計
    legacy: false,
  },
};

// Email 對應角色
export const EMAIL_ROLES: Record<string, Role> = {
  'eric19921204@gmail.com': ROLES.OWNER,
  // 未來：女兒的 email
  // 未來：合作者的 email
};
```

---

## 6.5 開發計劃

### 里程碑

```
Week 1：記帳系統 MVP
├── Task 1.1：建立 /admin/accounting 頁面骨架
├── Task 1.2：日期選擇器 + 餘額輸入元件
├── Task 1.3：入金記錄 CRUD
├── Task 1.4：計算邏輯 + 結果顯示
└── Task 1.5：40 萬門檻警示

Week 2：成本解析器強化
├── Task 2.1：成本解析器重構（規則式）
├── Task 2.2：LLM 備援整合
├── Task 2.3：單元測試（覆蓋所有範例）
├── Task 2.4：Dashboard 整合優化
└── Task 2.5：解析警告 UI

Week 3：Notion 知識庫
├── Task 3.1：建立 Notion 餐廳資料庫 + 填入資料
├── Task 3.2：建立 Notion 門票資料庫 + 填入資料
├── Task 3.3：建立 Notion 話術資料庫
├── Task 3.4：知識庫 API 端點
└── Task 3.5：/admin/knowledge 入口頁面

Week 4：整合 + 傳承
├── Task 4.1：行程表景點下拉連動門票
├── Task 4.2：門票自動計算
├── Task 4.3：傳承專區入口（連結 Notion）
├── Task 4.4：權限層級實作
└── Task 4.5：測試驗證 + 部署
```

### Git 分支策略

```
main
 │
 └── feature/phase6-accounting
      │
      ├── phase6/accounting-page      # 記帳頁面
      ├── phase6/cost-parser          # 成本解析器
      ├── phase6/knowledge-api        # 知識庫 API
      └── phase6/itinerary-tickets    # 行程表連動

合併策略：
1. 每個 Task 完成後 commit
2. 每個 Week 完成後 PR → feature/phase6-accounting
3. Phase 6 全部完成後 PR → main
```

### 測試策略

| 層級 | 涵蓋範圍 | 工具 |
|------|---------|------|
| 單元測試 | 成本解析器、計算邏輯 | Vitest |
| 整合測試 | Notion API 串接 | Vitest + MSW |
| E2E 測試 | 記帳流程、知識庫查詢 | Playwright |

### 驗收標準

**記帳系統：**
- [ ] 可選擇日期區間並輸入餘額
- [ ] 可新增/刪除入金記錄
- [ ] 計算結果正確（含 Notion 成本）
- [ ] 40 萬門檻警示正常顯示
- [ ] 只有 Owner 可存取

**成本解析器：**
- [ ] 6 個範例全部正確解析
- [ ] 不確定值有 ⚠️ 標記
- [ ] Dashboard 數字更準確

**知識庫：**
- [ ] Notion 資料庫結構正確
- [ ] 基礎資料已填入
- [ ] 網站可查詢餐廳/門票
- [ ] 行程表可連動門票資料

---

## 6.6 待確認事項

### 需要 Eric 提供

- [ ] Notion API Integration Token（用於建立知識庫）
- [ ] 確認現有 Notion 成本欄位的正確名稱
- [ ] 女兒目前年紀（規劃傳承內容分階段）

### 設計決策

| 問題 | 目前決定 | 狀態 |
|------|---------|------|
| 月報表 | 先不做，只做區間統計 | ✅ 已確認 |
| 匯率追蹤 | 簡化版（台幣→泰銖） | ✅ 已確認 |
| 成本解析 | 規則式 + LLM 混合 | ✅ 已確認 |
| 知識庫建立 | API 自動建立 | 待 Token |

---

## 相關文件

- Phase 3 內部工具：`docs/plans/2026-01-22-phase3-internal-tools.md`
- Dashboard 設計：`docs/plans/2026-01-21-dashboard-and-pdf-itinerary-design.md`
- 結構化編輯器：`docs/plans/2026-01-22-structured-form-editor-design.md`

---

*最後更新：2026-01-26*
